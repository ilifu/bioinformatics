Bootstrap: localimage
From: bionic_compile.sif

%labels
  Maintainer Dane Kennedy
  sra_tools_version 2.10.5

%help
  sra_tools 

%environment
  export SOFTWARE_PATH=/software
  export PATH=${SOFTWARE_PATH}/bin:${SOFTWARE_PATH}/ncbi/sra-tools/bin:${PATH}
  export SRA_TOOLS_VERSION=2.10.5
  export LD_LIBRARY_PATH=${SOFTWARE_PATH}/lib64:${LD_LIBRARY_PATH}
  export INCLUDE=${SOFTWARE_PATH}/include

# START APPRUNs

%apprun abi-dump
  exec /software/bin/abi-dump.2.10.5 "${@}"

%apprun abi-load
  exec /software/bin/abi-load.2.10.5 "${@}"

%apprun aggregate_profile
  exec /software/bin/aggregate_profile.pl "${@}"

%apprun align-cache
  exec /software/bin/align-cache.2.10.5 "${@}"

%apprun align-info
  exec /software/bin/align-info.2.10.5 "${@}"

%apprun bam-load
  exec /software/bin/bam-load.2.10.5 "${@}"

%apprun cache-mgr
  exec /software/bin/cache-mgr.2.10.5 "${@}"

%apprun ccextract
  exec /software/bin/ccextract.2.10.5 "${@}"

%apprun cg-load
  exec /software/bin/cg-load.2.10.5 "${@}"

%apprun copycat
  exec /software/bin/copycat.2.10.5 "${@}"

%apprun fasterq-dump-orig
  exec /software/bin/fasterq-dump-orig.2.10.5 "${@}"

%apprun fastq-dump-orig
  exec /software/bin/fastq-dump-orig.2.10.5 "${@}"

%apprun fastq-load
  exec /software/bin/fastq-load.2.10.5 "${@}"

%apprun helicos-load
  exec /software/bin/helicos-load.2.10.5 "${@}"

%apprun illumina-dump
  exec /software/bin/illumina-dump.2.10.5 "${@}"

%apprun illumina-load
  exec /software/bin/illumina-load.2.10.5 "${@}"

%apprun kar
  exec /software/bin/kar.2.10.5 "${@}"

%apprun kdbmeta
  exec /software/bin/kdbmeta.2.10.5 "${@}"

%apprun kget
  exec /software/bin/kget.2.10.5 "${@}"

%apprun latf-load
  exec /software/bin/latf-load.2.10.5 "${@}"

%apprun md5cp
  exec /software/bin/md5cp.2.10.5 "${@}"

%apprun mpijavac
  exec /software/bin/mpijavac.pl "${@}"

%apprun ompi_info
  exec /software/bin/ompi_info "${@}"

%apprun opal_wrapper
  exec /software/bin/opal_wrapper "${@}"

%apprun orte-clean
  exec /software/bin/orte-clean "${@}"

%apprun orte-info
  exec /software/bin/orte-info "${@}"

%apprun orte-server
  exec /software/bin/orte-server "${@}"

%apprun orted
  exec /software/bin/orted "${@}"

%apprun orterun
  exec /software/bin/orterun "${@}"

%apprun prefetch-orig
  exec /software/bin/prefetch-orig.2.10.5 "${@}"

%apprun profile2mat
  exec /software/bin/profile2mat.pl "${@}"

%apprun rcexplain
  exec /software/bin/rcexplain.2.10.5 "${@}"

%apprun read-filter-redact
  exec /software/bin/read-filter-redact.2.10.5 "${@}"

%apprun remote-fuser
  exec /software/bin/remote-fuser.2.10.5 "${@}"

%apprun sam-dump-orig
  exec /software/bin/sam-dump-orig.2.10.5 "${@}"

%apprun sff-dump
  exec /software/bin/sff-dump.2.10.5 "${@}"

%apprun sff-load
  exec /software/bin/sff-load.2.10.5 "${@}"

%apprun sra-pileup-orig
  exec /software/bin/sra-pileup-orig.2.10.5 "${@}"

%apprun sra-sort-cg
  exec /software/bin/sra-sort-cg.2.10.5 "${@}"

%apprun sra-sort
  exec /software/bin/sra-sort.2.10.5 "${@}"

%apprun sra-stat
  exec /software/bin/sra-stat.2.10.5 "${@}"

%apprun srapath-orig
  exec /software/bin/srapath-orig.2.10.5 "${@}"

%apprun sratools
  exec /software/bin/sratools.2.10.5 "${@}"

%apprun srf-load
  exec /software/bin/srf-load.2.10.5 "${@}"

%apprun test-sra
  exec /software/bin/test-sra.2.10.5 "${@}"

%apprun vdb-config
  exec /software/bin/vdb-config.2.10.5 "${@}"

%apprun vdb-copy
  exec /software/bin/vdb-copy.2.10.5 "${@}"

%apprun vdb-decrypt
  exec /software/bin/vdb-decrypt.2.10.5 "${@}"

%apprun vdb-diff
  exec /software/bin/vdb-diff.2.10.5 "${@}"

%apprun vdb-dump-orig
  exec /software/bin/vdb-dump-orig.2.10.5 "${@}"

%apprun vdb-encrypt
  exec /software/bin/vdb-encrypt.2.10.5 "${@}"

%apprun vdb-lock
  exec /software/bin/vdb-lock.2.10.5 "${@}"

%apprun vdb-passwd
  exec /software/bin/vdb-passwd.2.10.5 "${@}"

%apprun vdb-unlock
  exec /software/bin/vdb-unlock.2.10.5 "${@}"

%apprun vdb-validate
  exec /software/bin/vdb-validate.2.10.5 "${@}"

# END APPRUNs

%setup
  mkdir -p ${SINGULARITY_ROOTFS}/installer/ncbi
  cp -rT ./sra_tools/ncbi-vdb ${SINGULARITY_ROOTFS}/installer/ncbi/ncbi-vdb
  cp -rT ./sra_tools/ngs ${SINGULARITY_ROOTFS}/installer/ncbi/ngs
  cp -rT ./sra_tools/sra-tools ${SINGULARITY_ROOTFS}/installer/ncbi/sra-tools

%post
  export INSTALLER_PATH=/installer
  export SOFTWARE_PATH=/software
  export LD_LIBRARY_PATH=${SOFTWARE_PATH}/lib64:${SOFTWARE_PATH}/lib:${LD_LIBRARY_PATH}
  export LIBRARY_PATH=${SOFTWARE_PATH}/lib64${SOFTWARE_PATH}/lib:${LIBRARY_PATH}
  export CPATH=${SOFTWARE_PATH}/include:${CPATH}
  export INCLUDE=${SOFTWARE_PATH}/include:${INCLUDE}
  export PKG_CONFIG_PATH=${SOFTWARE_PATH}/lib/pkgconfig:${PKG_CONFIG_PATH}
  export SRA_TOOLS_VERSION=2.9.6
  export PATH=${SOFTWARE_PATH}/bin:${SOFTWARE_PATH}/ncbi/sra-tools/bin:${PATH}
  export DEBIAN_FRONTEND=noninteractive
  export VDB_SRCDIR=${INSTALLER_PATH}/ncbi/ncbi-vdb 

  # Update apt
  apt-get update -y && apt-get upgrade -y
  apt-get install -y libfuse2 libfuse-dev pkg-config libhdf5-dev

  # build ncbi-vdb
  cd ${INSTALLER_PATH}/ncbi/ncbi-vdb
  ./configure --with-hdf5-prefix=/usr --prefix=${SOFTWARE_PATH}
  make -j4
  make install

  # build ngs
  cd ${INSTALLER_PATH}/ncbi/ngs
  ./configure --prefix=${SOFTWARE_PATH}
  make
  make -C ngs-sdk
  make -C ngs-java
  make -C ngs-python
  make -C ngs-sdk install
  make -C ngs-java install
  make -C ngs-python install


    # build ncbi-vdb  # yes again -- there seem to be some circular dependencies?
    cd ${INSTALLER_PATH}/ncbi/ncbi-vdb
    ./configure --with-hdf5-prefix=/usr --prefix=${SOFTWARE_PATH}
    make
    make install

  cd ${INSTALLER_PATH}/ncbi/ngs
  make clean
  ./configure --prefix=${SOFTWARE_PATH}
  make -C ngs-sdk
  make -C ngs-java
  make -C ngs-python
  make -C ngs-sdk install
  make -C ngs-java install
  make -C ngs-python install
  make install

  # build sra-tools
  cd ${INSTALLER_PATH}/ncbi/sra-tools
  ./configure --with-hdf5-prefix=/usr --prefix=${SOFTWARE_PATH}
  make -j4
  make install

  # Cleanup the container
  rm -rf ${INSTALLER_PATH}/ncbi

  apt-get clean
  apt-get autoclean

%test
#  /software/bin/fastq-dump | grep -q "2.9.6"
